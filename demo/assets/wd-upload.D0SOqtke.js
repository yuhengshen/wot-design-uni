import{d as e,r as s,a0 as a,e as o,f as t,w as l,g as i,s as r,C as n,n as u,A as c,ac as d,am as p,k as m,Q as f,an as v,ao as y,x as h,y as _,i as w,F as b,j as g,z as k,h as C,t as x,u as F,al as T,p as z,l as P,ap as L,a3 as D,B as I,N as M}from"./index-ddWhPHnE.js";import{b as N,w as E,_ as K,e as S,n as j,c as U,d as A,m as $,r as R,E as G,x as H,i as O,G as B,M as Q,N as V}from"./wd-icon.CdzlT4Xd.js";import{h as X,g as q}from"./page-wraper.DJ6J_9uw.js";import{u as J}from"./useTranslate.D-OItNaP.js";const W=K(e({name:"wd-video-preview",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...N},setup(e,{expose:f}){const v=s(!1),y=a({url:"",poster:"",title:""});function h(){v.value=!1,d((()=>{y.url="",y.poster="",y.title=""}))}return X((()=>v.value)),f({open:function(e){v.value=!0,y.url=e.url,y.poster=e.poster,y.title=e.title},close:h}),(e,s)=>{const a=p,d=m;return v.value?(o(),t(d,{key:0,class:u(`wd-video-preview ${e.customClass}`),style:c(e.customStyle),onClick:h},{default:l((()=>[i(d,{class:"wd-video-preview__video",onClick:s[0]||(s[0]=n((()=>{}),["stop"]))},{default:l((()=>[y.url?(o(),t(a,{key:0,class:"wd-video-preview__video",controls:!0,poster:y.poster,title:y.title,"play-btn-position":"center",enableNative:!0,src:y.url,"enable-progress-gesture":!1},null,8,["poster","title","src"])):r("",!0)])),_:1}),i(E,{name:"close","custom-class":"wd-video-preview__close",onClick:h})])),_:1},8,["class","style"])):r("",!0)}}}),[["__scopeId","data-v-dfc3ea0a"]]);function Y(e){if(S(e.tempFiles)){const s=[];return e.tempFiles.forEach((async e=>{s.push({path:e.path||"",name:e.name||"",size:e.size,type:"image",thumb:e.path||""})})),s}return[{path:e.tempFiles.path||"",name:e.tempFiles.name||"",size:e.tempFiles.size,type:"image",thumb:e.tempFiles.path||""}]}const Z=K(e({name:"wd-upload",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...N,fileList:j(),action:U(""),header:{type:Object,default:()=>({})},multiple:A(!1),disabled:A(!1),limit:Number,showLimitNum:A(!0),maxSize:$(Number.MAX_VALUE),sourceType:{type:Array,default:()=>["album","camera"]},sizeType:{type:Array,default:()=>["original","compressed"]},name:U("file"),formData:{type:Object,default:()=>{}},onPreviewFail:Function,beforeUpload:Function,beforeChoose:Function,beforeRemove:Function,beforePreview:Function,buildFormData:Function,loadingType:U("ring"),loadingColor:U("#ffffff"),accept:U("image"),statusKey:U("status"),loadingSize:U("24px"),compressed:A(!0),maxDuration:$(60),camera:U("back"),imageMode:U("aspectFit"),successStatus:$(200),customEvokeClass:U(""),customPreviewClass:U(""),autoUpload:A(!0),reupload:A(!1),uploadMethod:Function},emits:["fail","change","success","progress","oversize","chooseerror","remove","update:fileList"],setup(e,{expose:a,emit:n}){const d=e,N=n;a({submit:()=>ee()});const{translate:K}=J("upload"),S=s([]),j=h((()=>!d.limit||S.value.length<d.limit)),U=s();function A(){N("update:fileList",S.value)}_((()=>d.fileList),(e=>{const{statusKey:s}=d;if(G(e,S.value))return;const a=e.map((e=>(e[s]=e[s]||"success",e.response=e.response||"",{...e,uid:H.id++})));S.value=a}),{deep:!0,immediate:!0}),_((()=>d.limit),(e=>{e&&e<S.value.length&&console.error("[wot-design]Error: props limit must less than fileList.length")}),{deep:!0,immediate:!0}),_((()=>d.beforePreview),(e=>{e&&!R(e)&&console.error("The type of beforePreview must be Function")}),{deep:!0,immediate:!0}),_((()=>d.onPreviewFail),(e=>{e&&!R(e)&&console.error("The type of onPreviewFail must be Function")}),{deep:!0,immediate:!0}),_((()=>d.beforeRemove),(e=>{e&&!R(e)&&console.error("The type of beforeRemove must be Function")}),{deep:!0,immediate:!0}),_((()=>d.beforeUpload),(e=>{e&&!R(e)&&console.error("The type of beforeUpload must be Function")}),{deep:!0,immediate:!0}),_((()=>d.beforeChoose),(e=>{e&&!R(e)&&console.error("The type of beforeChoose must be Function")}),{deep:!0,immediate:!0}),_((()=>d.buildFormData),(e=>{e&&!R(e)&&console.error("The type of buildFormData must be Function")}),{deep:!0,immediate:!0});const $=(e,s,a)=>{const{statusKey:o,uploadMethod:t}=d;e[o]="loading",R(t)?t(e,s,a):((e,s,a)=>{T({url:a.action,header:a.header,name:a.name,fileName:a.name,fileType:a.fileType,formData:s,filePath:e.url,success(o){o.statusCode===a.statusCode?a.onSuccess(o,e,s):a.onError({...o,errMsg:o.errMsg||""},e,s)},fail(o){a.onError(o,e,s)}}).onProgressUpdate((s=>{a.onProgress(s,e)}))})(e,s,a)};function X(e){return new Promise(((s,a)=>{M({src:e,success:e=>{s(e)},fail:e=>{a(e)}})}))}function Z(e,s){const{statusKey:a}=d,o={uid:H.id++,name:e.name||"",thumb:e.thumb||"",[a]:"pending",size:e.size||0,url:e.path,percent:0};"number"==typeof s?S.value.splice(s,1,o):S.value.push(o),d.autoUpload&&ee()}function ee(){const{buildFormData:e,formData:s={},statusKey:a}=d,{action:o,name:t,header:l={},accept:i,successStatus:r}=d,n=O(r)?r:200;for(const u of S.value)"pending"==u[a]&&(e?e({file:u,formData:s,resolve:e=>{e&&$(u,e,{onSuccess:ae,onError:se,onProgress:oe,action:o,header:l,name:t,fileName:t,fileType:i,statusCode:n})}}):$(u,s,{onSuccess:ae,onError:se,onProgress:oe,action:o,header:l,name:t,fileName:t,fileType:i,statusCode:n}))}function se(e,s,a){const{statusKey:o}=d,t=S.value.findIndex((e=>e.uid===s.uid));t>-1&&(S.value[t][o]="fail",S.value[t].error=e.message,S.value[t].response=e,N("fail",{error:e,file:s,formData:a}),A())}function ae(e,s,a){const{statusKey:o}=d,t=S.value.findIndex((e=>e.uid===s.uid));t>-1&&(S.value[t][o]="success",S.value[t].response=e.data,N("change",{fileList:S.value}),N("success",{file:s,fileList:S.value,formData:a}),A())}function oe(e,s){const a=S.value.findIndex((e=>e.uid===s.uid));a>-1&&(S.value[a].percent=e.progress,N("progress",{response:e,file:s}))}function te(e){const{multiple:s,maxSize:a,accept:o,sizeType:t,limit:l,sourceType:i,compressed:r,maxDuration:n,camera:u,beforeUpload:c}=d;(function({multiple:e,sizeType:s,sourceType:a,maxCount:o,accept:t,compressed:l,maxDuration:i,camera:r}){return new Promise(((n,u)=>{switch(t){case"image":f({count:e?Math.min(o,9):1,sizeType:s,sourceType:a,success:e=>n(Y(e)),fail:e=>{u(e)}});break;case"video":y({sourceType:a,compressed:l,maxDuration:i,camera:r,success:e=>{n(function(e){return[{path:e.tempFilePath||e.filePath||"",name:e.name||"",size:e.size,type:"video",thumb:e.thumbTempFilePath||"",duration:e.duration}]}(e))},fail:u});break;case"all":v({count:e?Math.min(o,100):1,type:t,success:e=>n(e.tempFiles),fail:u});break;default:f({count:e?Math.min(o,9):1,sizeType:s,sourceType:a,success:e=>n(Y(e)),fail:u})}}))})({multiple:s,sizeType:t,sourceType:i,maxCount:l?l-S.value.length:9,accept:o,compressed:r,maxDuration:n,camera:u}).then((o=>{let t=o;s||(t=t.slice(0,1));const l=async s=>{for(let o=0;o<s.length;o++){const t=s[o];if("image"===t.type&&!t.size){const e=await X(t.path);t.size=e.width*e.height}Number(t.size)<=a?Z(t,e):N("oversize",{file:t})}};c?c({files:t,fileList:S.value,resolve:e=>{e&&l(t)}}):l(t)})).catch((e=>{N("chooseerror",{error:e})}))}function le(e){if(d.disabled)return;const{beforeChoose:s}=d;s?s({fileList:S.value,resolve:s=>{s&&te(e)}}):te(e)}function ie(e){S.value.splice(S.value.findIndex((s=>s.uid===e.uid)),1),N("change",{fileList:S.value}),N("remove",{file:e}),A()}function re(e){L({filePath:e.url,showMenu:!0})}function ne(e,s){const{onPreviewFail:a}=d;D({urls:s,current:s[e],fail(){a?a({index:e,imgList:s}):I({title:"预览图片失败",icon:"none"})}})}function ue(e,s){var a;null==(a=U.value)||a.open({url:s[e].url,poster:s[e].thumb,title:s[e].name})}function ce(e){const{beforePreview:s,reupload:a}=d,o=B(S.value),t=o.findIndex((s=>s.url===e.url)),l=o.filter((e=>de(e))),i=l.findIndex((s=>s.url===e.url));a?le(t):s?s({file:e,index:t,imgList:[],fileList:o,resolve:e=>{e&&ue(i,l)}}):ue(i,l)}function de(e){return e.name&&Q(e.name)||Q(e.url)}function pe(e){return e.name&&V(e.name)||V(e.url)}return(e,s)=>{const a=z,n=m,f=p,v=P;return o(),w(b,null,[i(n,{class:u(["wd-upload",e.customClass]),style:c(e.customStyle)},{default:l((()=>[(o(!0),w(b,null,g(S.value,((s,c)=>(o(),t(n,{class:u(["wd-upload__preview",e.customPreviewClass]),key:c},{default:l((()=>[i(n,{class:"wd-upload__status-content"},{default:l((()=>[pe(s)?(o(),t(a,{key:0,src:s.url,mode:e.imageMode,class:"wd-upload__picture",onClick:e=>function(e){const{beforePreview:s,reupload:a}=d,o=B(S.value),t=o.findIndex((s=>s.url===e.url)),l=o.filter((e=>pe(e))).map((e=>e.url)),i=l.findIndex((s=>s===e.url));a?le(t):s?s({file:e,index:t,fileList:o,imgList:l,resolve:e=>{e&&ne(i,l)}}):ne(i,l)}(s)},null,8,["src","mode","onClick"])):de(s)?(o(),w(b,{key:1},[s.thumb?(o(),t(n,{key:0,class:"wd-upload__video",onClick:e=>ce(s)},{default:l((()=>[i(a,{src:s.thumb,mode:e.imageMode,class:"wd-upload__picture"},null,8,["src","mode"]),i(E,{name:"play-circle-filled","custom-class":"wd-upload__video-paly"})])),_:2},1032,["onClick"])):(o(),t(n,{key:1,class:"wd-upload__video",onClick:e=>ce(s)},{default:l((()=>[i(f,{src:s.url,title:s.name||"视频"+c,"object-fit":"contain",controls:!1,poster:s.thumb,autoplay:!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"show-play-btn":!1,"show-loading":!1,"show-progress":!1,"show-mute-btn":!1,"enable-progress-gesture":!1,enableNative:!0,class:"wd-upload__video"},null,8,["src","title","poster"]),i(E,{name:"play-circle-filled","custom-class":"wd-upload__video-paly"})])),_:2},1032,["onClick"]))],64)):(o(),t(n,{key:2,class:"wd-upload__file",onClick:e=>function(e){const{beforePreview:s,reupload:a}=d,o=B(S.value),t=o.findIndex((s=>s.url===e.url));a?le(t):s?s({file:e,index:t,imgList:[],fileList:o,resolve:s=>{s&&re(e)}}):re(e)}(s)},{default:l((()=>[i(E,{name:"file","custom-class":"wd-upload__file-icon"}),i(n,{class:"wd-upload__file-name"},{default:l((()=>[C(x(s.name||s.url),1)])),_:2},1024)])),_:2},1032,["onClick"]))])),_:2},1024),"success"!==s[d.statusKey]?(o(),t(n,{key:0,class:"wd-upload__mask wd-upload__status-content"},{default:l((()=>["loading"===s[d.statusKey]?(o(),t(n,{key:0,class:"wd-upload__status-content"},{default:l((()=>[i(q,{type:e.loadingType,size:e.loadingSize,color:e.loadingColor},null,8,["type","size","color"]),i(v,{class:"wd-upload__progress-txt"},{default:l((()=>[C(x(s.percent)+"%",1)])),_:2},1024)])),_:2},1024)):r("",!0),"fail"===s[d.statusKey]?(o(),t(n,{key:1,class:"wd-upload__status-content"},{default:l((()=>[i(E,{name:"close-outline","custom-class":"wd-upload__icon"}),i(v,{class:"wd-upload__progress-txt"},{default:l((()=>[C(x(s.error||F(K)("error")),1)])),_:2},1024)])),_:2},1024)):r("",!0)])),_:2},1024)):r("",!0),"loading"===s[d.statusKey]||e.disabled?r("",!0):(o(),t(E,{key:1,name:"error-fill","custom-class":"wd-upload__close",onClick:e=>function(e){const{beforeRemove:s}=d,a=e,o=S.value[a];s?s({file:o,index:a,fileList:S.value,resolve:e=>{e&&ie(o)}}):ie(o)}(c)},null,8,["onClick"])),e.$slots["preview-cover"]?k(e.$slots,"preview-cover",{key:2,file:s,index:c},void 0,!0):r("",!0)])),_:2},1032,["class"])))),128)),j.value?(o(),w(b,{key:0},[e.$slots.default?(o(),t(n,{key:0,class:u(["wd-upload__evoke-slot",e.customEvokeClass]),onClick:le},{default:l((()=>[k(e.$slots,"default",{},void 0,!0)])),_:3},8,["class"])):(o(),t(n,{key:1,onClick:le,class:u(["wd-upload__evoke",e.disabled?"is-disabled":"",e.customEvokeClass])},{default:l((()=>[i(E,{class:"wd-upload__evoke-icon",name:"fill-camera"}),e.limit&&e.showLimitNum?(o(),t(n,{key:0,class:"wd-upload__evoke-num"},{default:l((()=>[C("（"+x(S.value.length)+"/"+x(e.limit)+"）",1)])),_:1})):r("",!0)])),_:1},8,["class"]))],64)):r("",!0)])),_:3},8,["class","style"]),i(W,{ref_key:"videoPreview",ref:U},null,512)],64)}}}),[["__scopeId","data-v-b1f637cf"]]);export{Z as _};
