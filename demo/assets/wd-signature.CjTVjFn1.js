import{d as t,r as e,a0 as a,y as s,x as l,q as i,V as n,b as o,c as r,e as u,f as d,w as c,g as h,A as v,z as p,O as g,P as f,M as m,k as x,i as y,F as b,h as W,t as w,u as T,s as k,D as S}from"./index-ddWhPHnE.js";import{_ as C}from"./wd-button.D-L9G8tD.js";import{b as X,q as P,D as Y,i as M,a as _,o as F,g as H,_ as q}from"./wd-icon.CdzlT4Xd.js";import{u as L}from"./useTranslate.D-OItNaP.js";const D=q(t({name:"wd-signature",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...X,penColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},clearText:String,revokeText:String,restoreText:String,confirmText:String,fileType:{type:String,default:"png"},quality:{type:Number,default:1},exportScale:{type:Number,default:1},disabled:{type:Boolean,default:!1},height:P,width:P,backgroundColor:String,disableScroll:{type:Boolean,default:!0},enableHistory:{type:Boolean,default:!1},step:{type:Number,default:1},undoText:String,redoText:String,pressure:{type:Boolean,default:!1},minWidth:{type:Number,default:2},maxWidth:{type:Number,default:6},minSpeed:{type:Number,default:1.5}},emits:["start","end","signing","confirm","clear"],setup(t,{expose:X,emit:P}){const q=t,D=P,{translate:N}=L("signature"),{proxy:R}=S(),z=e(`signature${Y()}`);let j=null;const B=e(!1),$=e(1),E=a({canvasWidth:0,canvasHeight:0,ctx:null});s((()=>q.penColor),(()=>{ot()})),s((()=>q.lineWidth),(()=>{ot()}));const I=l((()=>{const t={};return M(q.width)&&(t.width=_(q.width)),M(q.height)&&(t.height=_(q.height)),`${F(t)};`})),J=l((()=>q.disableScroll)),A=l((()=>q.enableHistory)),G=e([]),O=e([]),U=e(),V=e(0);const K=()=>q.pressure?(q.maxWidth+q.minWidth)/2:q.lineWidth,Q=t=>{t.preventDefault(),B.value=!0,ot(),D("start",t);const{x:e,y:a}=t.touches[0];U.value={points:[{x:e,y:a,t:Date.now()}],color:q.penColor,width:K(),backgroundColor:q.backgroundColor,isPressure:q.pressure},O.value=[],st(t)},Z=t=>{t.preventDefault(),B.value=!1,U.value&&(G.value.push({...U.value,points:U.value.points.map((t=>({...t,t:t.t,speed:t.speed,distance:t.distance,lineWidth:t.lineWidth,lastX1:t.lastX1,lastY1:t.lastY1,lastX2:t.lastX2,lastY2:t.lastY2,isFirstPoint:t.isFirstPoint})))}),V.value=G.value.length),U.value=void 0;const{ctx:e}=E;e&&e.beginPath(),D("end",t)},tt=(t=!1)=>{!t&&E.canvasHeight&&E.canvasWidth||new Promise((t=>{const{ctx:e}=E;if(e)return t(e);H(`#${z.value}`,!1,R).then((e=>{var a,s;a=e.width,s=e.height,E.canvasHeight=s*$.value,E.canvasWidth=a*$.value,E.ctx=g(z.value,R),E.ctx&&E.ctx.scale($.value,$.value),t(E.ctx)}))})).then((()=>{const{ctx:t}=E;t&&M(q.backgroundColor)&&(t.setFillStyle(q.backgroundColor),t.fillRect(0,0,E.canvasWidth,E.canvasHeight),t.draw())}))},et=()=>{G.value=[],O.value=[],V.value=0,function(){const{canvasWidth:t,canvasHeight:e,ctx:a}=E;a&&(a.clearRect(0,0,t,e),M(q.backgroundColor)&&(a.setFillStyle(q.backgroundColor),a.fillRect(0,0,t,e)),a.draw())}(),D("clear")},at=()=>{!function(){const{fileType:t,quality:e,exportScale:a}=q,{canvasWidth:s,canvasHeight:l}=E;f({width:s*a,height:l*a,destWidth:s*a,destHeight:l*a,fileType:t,quality:e,canvasId:z.value,canvas:j,success:t=>{const e={tempFilePath:t.tempFilePath,width:s*a/$.value,height:l*a/$.value,success:!0};D("confirm",e)},fail:()=>{const t={tempFilePath:"",width:s*a/$.value,height:l*a/$.value,success:!1};D("confirm",t)}},R)}()},st=t=>{t.preventDefault();const{ctx:e}=E;if(!B.value||q.disabled||!e)return;const{x:a,y:s}=t.touches[0],l={x:a,y:s,t:Date.now()};if(U.value){const t=U.value.points,i=t[t.length-1];if(i.t===l.t||i.x===a&&i.y===s)return;if(l.distance=Math.sqrt(Math.pow(l.x-i.x,2)+Math.pow(l.y-i.y,2)),l.speed=l.distance/(l.t-i.t||.1),q.pressure&&(l.lineWidth=function(t){if(!q.pressure)return q.lineWidth;const e=q.minSpeed||1.5,a=Math.min(10*e,Math.max(e,t)),s=(q.maxWidth-q.minWidth)*(a-e)/e,l=Math.max(q.maxWidth-s,q.minWidth);return Math.min(l,q.maxWidth)}(l.speed),t.length>=2)){if(t[t.length-2].lineWidth&&i.lineWidth){const t=(l.lineWidth-i.lineWidth)/i.lineWidth,e=.2;if(Math.abs(t)>e){const a=t>0?e:-e;l.lineWidth=i.lineWidth*(1+a)}}}t.push(l),q.pressure?t.length>=2&&function(t,e){const{ctx:a}=E;if(!a)return;const s=e.x-t.x,l=e.y-t.y;if(Math.sqrt(s*s+l*l)<=2)e.lastX1=e.lastX2=t.x+.5*s,e.lastY1=e.lastY2=t.y+.5*l;else{const a=e.speed||0,i=q.minSpeed||1.5,n=Math.max(.1,Math.min(.9,a/(10*i)));e.lastX1=t.x+s*(.2+.3*n),e.lastY1=t.y+l*(.2+.3*n),e.lastX2=t.x+s*(.8-.3*n),e.lastY2=t.y+l*(.8-.3*n)}const i=e.lineWidth||q.lineWidth;"number"==typeof t.lastX1?(a.setLineWidth(i),a.beginPath(),a.moveTo(t.lastX2,t.lastY2),a.quadraticCurveTo(t.x,t.y,e.lastX1,e.lastY1),a.stroke(),t.isFirstPoint||(a.beginPath(),a.moveTo(t.lastX1,t.lastY1),a.quadraticCurveTo(t.x,t.y,t.lastX2,t.lastY2),a.stroke()),a.draw(!0)):e.isFirstPoint=!0}(i,l):(e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(l.x,l.y),e.stroke(),e.draw(!0))}D("signing",t)},lt=()=>{const{ctx:t}=E;t&&(M(q.backgroundColor)?(t.setFillStyle(q.backgroundColor),t.fillRect(0,0,E.canvasWidth,E.canvasHeight)):t.clearRect(0,0,E.canvasWidth,E.canvasHeight),0!==G.value.length?(G.value.forEach((e=>{e.points.length&&(t.setStrokeStyle(e.color),t.setLineJoin("round"),t.setLineCap("round"),e.isPressure&&q.pressure?e.points.forEach(((a,s)=>{if(0===s)return;const l=e.points[s-1],i=a.x-l.x,n=a.y-l.y;if(Math.sqrt(i*i+n*n)<=2)a.lastX1=a.lastX2=l.x+.5*i,a.lastY1=a.lastY2=l.y+.5*n;else{const t=a.speed||0,e=q.minSpeed||1.5,s=Math.max(.1,Math.min(.9,t/(10*e)));a.lastX1=l.x+i*(.2+.3*s),a.lastY1=l.y+n*(.2+.3*s),a.lastX2=l.x+i*(.8-.3*s),a.lastY2=l.y+n*(.8-.3*s)}const o=a.lineWidth||e.width;"number"==typeof l.lastX1?(t.setLineWidth(o),t.beginPath(),t.moveTo(l.lastX2,l.lastY2),t.quadraticCurveTo(l.x,l.y,a.lastX1,a.lastY1),t.stroke(),l.isFirstPoint||(t.beginPath(),t.moveTo(l.lastX1,l.lastY1),t.quadraticCurveTo(l.x,l.y,l.lastX2,l.lastY2),t.stroke())):a.isFirstPoint=!0})):(t.setLineWidth(e.width),e.points.forEach(((a,s)=>{if(0===s)return;const l=e.points[s-1];t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(a.x,a.y),t.stroke()}))))})),t.draw()):t.draw())},it=()=>{if(!G.value.length)return;const t=Math.min(q.step,G.value.length),e=G.value.splice(G.value.length-t);O.value.push(...e),V.value=Math.max(0,V.value-t),lt()},nt=()=>{if(!O.value.length)return;const t=Math.min(q.step,O.value.length),e=O.value.splice(O.value.length-t);G.value.push(...e),V.value=Math.min(G.value.length,V.value+t),lt()};function ot(){const{ctx:t}=E;t&&(t.setLineWidth(K()),t.setStrokeStyle(q.penColor),t.setLineJoin("round"),t.setLineCap("round"))}return i((()=>{tt()})),n((()=>{})),X({init:tt,clear:et,confirm:at,restore:nt,revoke:it}),(t,e)=>{const a=m,s=x,l=o(r("wd-button"),C);return u(),d(s,{class:"wd-signature"},{default:c((()=>[h(s,{class:"wd-signature__content"},{default:c((()=>[h(a,{class:"wd-signature__content-canvas","canvas-id":z.value,style:v(I.value),width:E.canvasWidth,height:E.canvasHeight,id:z.value,"disable-scroll":J.value,onTouchstart:Q,onTouchend:Z,onTouchmove:st},null,8,["canvas-id","style","width","height","id","disable-scroll"])])),_:1}),h(s,{class:"wd-signature__footer"},{default:c((()=>[p(t.$slots,"footer",{clear:et,confirm:at,currentStep:V.value,revoke:it,restore:nt,canUndo:G.value.length>0,canRedo:O.value.length>0,historyList:G.value},(()=>[A.value?(u(),y(b,{key:0},[h(l,{size:"small",plain:"",onClick:it,disabled:G.value.length<=0},{default:c((()=>[W(w(t.revokeText||T(N)("revokeText")),1)])),_:1},8,["disabled"]),h(l,{size:"small",plain:"",onClick:nt,disabled:O.value.length<=0},{default:c((()=>[W(w(t.restoreText||T(N)("restoreText")),1)])),_:1},8,["disabled"])],64)):k("",!0),h(l,{size:"small",plain:"",onClick:et},{default:c((()=>[W(w(t.clearText||T(N)("clearText")),1)])),_:1}),h(l,{size:"small",onClick:at},{default:c((()=>[W(w(t.confirmText||T(N)("confirmText")),1)])),_:1})]),!0)])),_:3})])),_:3})}}}),[["__scopeId","data-v-0ccd6418"]]);export{D as _};
