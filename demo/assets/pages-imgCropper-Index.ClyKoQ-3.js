import{d as e,r as a,L as l,y as t,x as u,e as s,f as o,w as i,g as c,n,A as r,s as v,h as m,t as d,u as p,k as h,p as g,M as f,N as w,O as _,D as x,P as y,b,c as M,Q as S}from"./index-ddWhPHnE.js";import{b as T,d as $,c as k,m as I,k as N,w as C,o as j,a as H,_ as V}from"./wd-icon.CdzlT4Xd.js";import{_ as q}from"./wd-button.D-L9G8tD.js";import{u as W}from"./useTranslate.D-OItNaP.js";import{_ as P}from"./wd-img.DXQWSSpY.js";import{_ as X}from"./demo-block.C_jTIrrw.js";import{_ as Y}from"./page-wraper.DJ6J_9uw.js";import"./index.CM-GNf6Q.js";import"./wd-cell.DKtYKzk0.js";const z=e({name:"wd-img-cropper",options:{virtualHost:!0,addGlobalClass:!0,styleIsolation:"shared"},props:{...T,modelValue:$(!1),cancelButtonText:String,confirmButtonText:String,disabledRotate:$(!1),fileType:k("png"),quality:I(1),exportScale:I(2),imgSrc:k(""),imgWidth:N(""),imgHeight:N(""),maxScale:I(3)},emits:["imgloaded","imgloaderror","cancel","confirm","update:modelValue"],setup(e,{expose:b,emit:M}){let S=null,T=null,$=!0,k=null,I=null;const N=.85,V=e,P=M,{translate:X}=W("img-cropper"),Y=a(0),z=a(!1),A=a(0),F=a(0),R=a(0),B=a(0),O=a(20),L=a(0),D=a(0),E=a(""),G=a(""),Q=a(2),U=a(1),J=a(l().windowWidth/2),K=a(l().windowHeight/2*N),Z=a(null),ee=a(l()),ae=a(!0),le=a([{x:"",y:""},{x:"",y:""}]),te=a(""),ue=a(null),{proxy:se}=x();t((()=>V.modelValue),(e=>{if(e){k=V.imgWidth,I=V.imgHeight,ee.value=l();const e=ee.value.windowWidth-2*O.value;R.value=e,B.value=e,D.value=(ee.value.windowHeight*N-e)/2,L.value=O.value,Q.value=V.exportScale,G.value=e,E.value=e,function(){if(k&&"string"==typeof k&&-1!==k.indexOf("%")){const e=k.replace("%","");k=ee.value.windowWidth/100*Number(e),A.value=k}else k&&"number"==typeof k&&(A.value=k);if(I&&"string"==typeof I&&-1!==I.indexOf("%")){const e=V.imgHeight.replace("%","");I=ee.value.windowHeight/100*Number(e),A.value=I}else I&&"number"==typeof I&&(A.value=Number(k))}(),ue.value||(ue.value=_("wd-img-cropper-canvas",se)),V.imgSrc&&ve()}else re()}),{deep:!0,immediate:!0}),t((()=>V.imgSrc),(e=>{e&&ve()}),{deep:!0,immediate:!0}),t((()=>Y.value),(e=>{e%90&&(Y.value=90*Math.round(e/90))}),{deep:!0,immediate:!0}),t((()=>z.value),(e=>{S&&clearTimeout(S),e&&(S=setTimeout((()=>{ce(!1),clearTimeout(S)}),300))}),{deep:!0,immediate:!0});const oe=u((()=>j({position:"absolute",right:0,width:"56px","border-radius":"16px","font-size":"16px"}))),ie=u((()=>{const e={width:A.value?H(A.value):"auto",height:F.value?H(F.value):"auto",transform:`translate(${H(J.value-A.value/2)}, ${H(K.value-F.value/2)}) scale(${U.value}) rotate(${Y.value}deg)`,"transition-duration":(z.value?.4:0)+"s"};return j(e)}));function ce(e){z.value=e}function ne(e){e&&!V.disabledRotate&&(ce(!0),Y.value=e,me())}function re(){const{windowHeight:e,windowWidth:a}=l();U.value=1,Y.value=0,J.value=a/2,K.value=e/2*N}function ve(){V.imgSrc&&w({src:V.imgSrc,success:e=>{Z.value=e,function(){let e=A.value,a=F.value;I||k?I&&!k?e=Z.value.width/Z.value.height*Number(I):(!I&&k||I&&k)&&(a=Z.value.height/Z.value.width*Number(k)):(e=Z.value.width,a=Z.value.height,A.value/F.value>R.value/B.value?(a=B.value,e=Z.value.width/Z.value.height*B.value):(e=R.value,a=Z.value.height/Z.value.width*R.value));A.value=e,F.value=a}(),re()},fail:()=>{}})}function me(e){const a=e||U.value;let l=J.value,t=K.value,u=A.value,s=F.value;Y.value/90%2&&(u=F.value,s=A.value),l=u*a/2+L.value>=l?l:u*U.value/2+L.value,l=L.value+R.value-u*a/2<=l?l:L.value+R.value-u*a/2,t=s*a/2+D.value>=t?t:s*a/2+D.value,t=D.value+B.value-s*a/2<=t?t:D.value+B.value-s*a/2,U.value=a,K.value=t,J.value=l}function de(e){if(ae.value=!1,1===e.touches.length)le.value[0]={x:e.touches[0].clientX-J.value,y:e.touches[0].clientY-K.value};else{const a=Math.abs(e.touches[1].clientX-e.touches[0].clientX),l=Math.abs(e.touches[1].clientY-e.touches[0].clientY);te.value=Math.sqrt(Math.pow(a,2)+Math.pow(l,2))}}function pe(e){if(!ae.value&&$)if("android"===ee.value.platform?(T&&clearTimeout(T),T=setTimeout((()=>{$=!0}),25)):!$&&($=!0),1===e.touches.length){const{x:a,y:l}=le.value[0],t=e.touches[0].clientX-Number(a),u=e.touches[0].clientY-Number(l);J.value=t,K.value=u,me()}else{const a=Math.abs(e.touches[1].clientX-e.touches[0].clientX),l=Math.abs(e.touches[1].clientY-e.touches[0].clientY),t=Math.sqrt(Math.pow(a,2)+Math.pow(l,2)),u=U.value*(t/Number(te.value));U.value=Math.min(u,V.maxScale),function(){let e=A.value,a=F.value,l=U.value;Y.value/90%2&&(e=F.value,a=A.value),e*l<R.value&&(l=R.value/e),a*l<B.value&&(l=B.value/a),me(l)}(),te.value=Math.sqrt(Math.pow(a,2)+Math.pow(l,2))}}function he(){ae.value=!0}function ge(e){P("imgloaded",e)}function fe(e){P("imgloaderror",e)}function we(){ne(Y.value-90)}function _e(){P("cancel"),P("update:modelValue",!1)}function xe(){!function(){if(!V.imgSrc)return;const e=()=>{const e=A.value*U.value*V.exportScale,a=F.value*U.value*V.exportScale,l=J.value-L.value,t=K.value-D.value;ue.value.translate(l*V.exportScale,t*V.exportScale),V.disabledRotate||ue.value.rotate(Y.value*Math.PI/180),ue.value.drawImage(V.imgSrc,-e/2,-a/2,e,a),ue.value.restore(),ue.value.draw(!1,(()=>{!function(){const{fileType:e,quality:a,exportScale:l}=V;y({width:R.value*l,height:Math.round(B.value*l),destWidth:R.value*l,destHeight:Math.round(B.value*l),fileType:e,quality:a,canvasId:"wd-img-cropper-canvas",success:e=>{const a={tempFilePath:e.tempFilePath,width:R.value*l,height:B.value*l};P("confirm",a)},complete:()=>{P("update:modelValue",!1)}},se)}()}))};G.value=B.value,E.value=R.value,e()}()}function ye(){}return b({revertIsAnimation:ce,setRoate:ne,resetImg:re}),(e,a)=>{const l=h,t=g,u=f;return e.modelValue?(s(),o(l,{key:0,class:n(`wd-img-cropper ${e.customClass}`),style:r(e.customStyle),onTouchmove:ye},{default:i((()=>[c(l,{class:"wd-img-cropper__wrapper"},{default:i((()=>[c(l,{class:"wd-img-cropper__cut"},{default:i((()=>[c(l,{class:n("wd-img-cropper__cut--top "+(ae.value?"":"is-hightlight")),style:r(`height: ${D.value}px;`)},null,8,["class","style"]),c(l,{class:"wd-img-cropper__cut--middle"},{default:i((()=>[c(l,{class:n("wd-img-cropper__cut--left "+(ae.value?"":"is-hightlight")),style:r(`width: ${L.value}px; height: ${R.value}px;`)},null,8,["class","style"]),c(l,{class:"wd-img-cropper__cut--body",style:r(`width: ${R.value}px; height: ${B.value}px;`)},{default:i((()=>[c(l,{class:"is-gridlines-x"}),c(l,{class:"is-gridlines-y"}),c(l,{class:"is-left-top"}),c(l,{class:"is-left-bottom"}),c(l,{class:"is-right-top"}),c(l,{class:"is-right-bottom"})])),_:1},8,["style"]),c(l,{class:n("wd-img-cropper__cut--right "+(ae.value?"":"is-hightlight"))},null,8,["class"])])),_:1}),c(l,{class:n("wd-img-cropper__cut--bottom "+(ae.value?"":"is-hightlight"))},null,8,["class"])])),_:1}),c(t,{prop:z.value,"change:prop":e.animation?e.animation.setAnimation:"",class:"wd-img-cropper__img",src:e.imgSrc,style:r(ie.value),"lazy-load":!1,onTouchstart:de,onTouchmove:pe,onTouchend:he,onError:fe,onLoad:ge},null,8,["prop","change:prop","src","style"])])),_:1}),c(u,{"canvas-id":"wd-img-cropper-canvas",id:"wd-img-cropper-canvas",class:"wd-img-cropper__canvas","disable-scroll":!0,style:r(`width: ${Number(E.value)*Q.value}px; height: ${Number(G.value)*Q.value}px;`)},null,8,["style"]),c(l,{class:"wd-img-cropper__footer"},{default:i((()=>[e.disabledRotate?v("",!0):(s(),o(C,{key:0,"custom-class":"wd-img-cropper__rotate",name:"rotate",onClick:we})),c(l,{class:"wd-img-cropper__footer--button"},{default:i((()=>[c(l,{class:"is-cancel",onClick:_e},{default:i((()=>[m(d(e.cancelButtonText||p(X)("cancel")),1)])),_:1}),c(q,{size:"small","custom-style":oe.value,onClick:xe},{default:i((()=>[m(d(e.confirmButtonText||p(X)("confirm")),1)])),_:1},8,["custom-style"])])),_:1})])),_:1})])),_:1},8,["class","style"])):v("",!0)}}});const A={setAnimation:function(e,a,l){if(e)var t=l.setTimeout((function(){l.callMethod("revertIsAnimation",!1),l.clearTimeout(t)}),300)}},F=e=>{e.$wxs||(e.$wxs=[]),e.$wxs.push("animation"),e.mixins||(e.mixins=[]),e.mixins.push({beforeCreate(){this.animation=A}})};F(z);const R=V(z,[["__scopeId","data-v-137c77a7"]]),B=V(e({__name:"Index",setup(e){const l=a(""),t=a(""),u=a(!1);function n(){S({count:1,success:e=>{const a=e.tempFilePaths[0];l.value=a,u.value=!0}})}function r(e){const{tempFilePath:a}=e;t.value=a}function d(e){console.log("加载失败",e)}function p(e){console.log("加载成功",e)}function g(e){console.log("取消",e)}return(e,a)=>{const f=b(M("wd-img-cropper"),R),w=b(M("wd-icon"),C),_=h,x=b(M("wd-img"),P),y=b(M("demo-block"),X),S=b(M("page-wraper"),Y);return s(),o(S,null,{default:i((()=>[c(y,{title:"基本用法",style:{"text-align":"center"}},{default:i((()=>[c(f,{modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=e=>u.value=e),"img-src":l.value,onConfirm:r,onCancel:g,onImgloaderror:d,onImgloaded:p},null,8,["modelValue","img-src"]),c(_,{class:"profile"},{default:i((()=>[t.value?v("",!0):(s(),o(_,{key:0,class:"img",onClick:n},{default:i((()=>[c(w,{name:"fill-camera","custom-class":"img-icon"})])),_:1})),t.value?(s(),o(x,{key:1,round:"",width:"200px",height:"200px",src:t.value,mode:"aspectFit","custom-class":"profile-img",onClick:n},null,8,["src"])):v("",!0),c(_,{style:{"font-size":"14px"}},{default:i((()=>[m("点击上传头像")])),_:1})])),_:1})])),_:1})])),_:1})}}}),[["__scopeId","data-v-34a27984"]]);export{B as default};
